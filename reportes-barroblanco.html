<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - PAE Barroblanco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- ‚ö†Ô∏è IMPORTANTE: Este archivo debe estar en js/ -->
    <script src="js/barroblanco-data.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .chart-container {
            height: 400px;
            width: 100%;
        }
        
        .chart-container-tall {
            height: 600px;
            width: 100%;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .filter-section {
            transition: all 0.3s ease;
        }
        
        .filter-section.collapsed {
            max-height: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }
        
        .sede-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .sede-principal {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .sede-primaria {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .sede-maria-inmaculada {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .report-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Mobile Menu */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.show {
            transform: translateX(0);
        }
        
        .mobile-nav-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: block;
            text-decoration: none;
            color: #374151;
            font-weight: 500;
        }
        
        .mobile-nav-item:hover {
            background-color: #f3f4f6;
            color: #1e3a8a;
        }
        
        @media (max-width: 768px) {
            .desktop-nav {
                display: none;
            }
            .mobile-nav-button {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-nav-button {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-800 to-blue-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-utensils text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">PAE Barroblanco</h1>
                        <p class="text-xs text-gray-500">Reportes y Estad√≠sticas</p>
                    </div>
                </div>
                <!-- Desktop Navigation -->
                <!-- esta clase pone en azul y con una linea debajo el item seleccionado class"nav-link text-blue-800 font-semibold border-b-2 border-blue-800 pb-1 px-3 py-2" -->
                <div class="desktop-nav flex items-center space-x-6">
                    <a href="index.html" class="nav-link text-gray-600 hover:text-blue-800 transition-colors px-3 py-2 rounded-md">
                        <i class="fas fa-home mr-2"></i>Inicio</a>
                    <a href="registro-mejorado.html" class="nav-link text-gray-600 hover:text-blue-800 transition-colors px-3 py-2 rounded-md">
                        <i class="fas fa-clipboard-check mr-2"></i>Registro</a>
                    <a href="qr-generator.html" class="nav-link text-gray-600 hover:text-blue-800 transition-colors px-3 py-2 rounded-md">
                        <i class="fas fa-qrcode mr-2"></i>C√≥digos QR</a>
                    <a href="reportes-barroblanco.html" class="nav-link text-blue-800 font-semibold border-b-2 border-blue-800 pb-1 px-3 py-2 bg-blue-50 rounded-lg">
                        <i class="fas fa-chart-bar mr-2"></i>Reportes</a>
                    <a href="estudiantes-barroblanco.html" class="nav-link text-gray-600 hover:text-blue-800 transition-colors px-3 py-2 rounded-md">
                        <i class="fas fa-users mr-2"></i>Estudiantes</a>
                    <button onclick="AUTH_SYSTEM.logout()" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-sign-out-alt mr-2"></i>Salir</button>
                </div>
                
                <!-- Mobile Navigation Button -->
                <div class="mobile-nav-button flex items-center">
                    <button onclick="toggleMobileMenu()" class="text-gray-600 hover:text-blue-800 p-2">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="mobile-menu fixed top-16 left-0 w-64 h-full bg-white shadow-lg z-40 ">
            <div class="py-4">
                <a href="index.html" class="mobile-nav-item">
                    <i class="fas fa-home mr-3"></i>Inicio</a>
                <a href="registro-mejorado.html" class="mobile-nav-item">
                    <i class="fas fa-clipboard-check mr-3"></i>Registro</a>
                <a href="qr-generator.html" class="mobile-nav-item">
                    <i class="fas fa-qrcode mr-3"></i>C√≥digos QR</a>
                <a href="reportes-barroblanco.html" class="mobile-nav-item text-blue-800">
                    <i class="fas fa-chart-bar mr-3"></i>Reportes</a>
                <a href="estudiantes-barroblanco.html" class="mobile-nav-item">
                    <i class="fas fa-users mr-3"></i>Estudiantes</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="pt-20 pb-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">Reportes y Estad√≠sticas PAE</h2>
                <p class="text-xl text-gray-600">An√°lisis detallado de asistencia y alimentaci√≥n escolar</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="exportReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors shadow-lg">
                    <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                </button>
                <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors shadow-lg">
                    <i class="fas fa-print mr-2"></i>Imprimir
                </button>
            </div>

            <!-- Filters Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-filter mr-2 text-blue-600"></i>Filtros
                    </h3>
                    <button onclick="toggleFilters()" class="text-gray-600 hover:text-gray-800">
                        <i id="filterToggle" class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div id="filterSection" class="filter-section">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sede</label>
                            <select id="sedeFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="">Todas las sedes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Grupo</label>
                            <select id="gradeFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="">Todos los grupos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Inicio</label>
                            <input type="date" id="startDate" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Fin</label>
                            <input type="date" id="endDate" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Estudiantes</p>
                            <p class="text-3xl font-bold text-blue-600" id="totalStudents">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Asistencia Hoy</p>
                            <p class="text-3xl font-bold text-green-600" id="attendanceToday">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-user-check text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Estudiantes Sordos</p>
                            <p class="text-3xl font-bold text-yellow-600" id="sordosCount">0</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-hands text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">% Asistencia</p>
                            <p class="text-3xl font-bold text-purple-600" id="attendancePercentage">0%</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-percentage text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Attendance by Sede Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-building mr-2 text-blue-600"></i>Asistencia por Sede
                    </h3>
                    <div class="chart-container" id="sedeChart"></div>
                </div>

                <!-- Attendance by Grade Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-graduation-cap mr-2 text-green-600"></i>Asistencia por Grado
                    </h3>
                    <div class="chart-container-tall" id="gradeChart"></div>
                </div>
            </div>

            <!-- Time Series Chart -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-line mr-2 text-purple-600"></i>Tendencia de Asistencia (√öltimos 30 d√≠as)
                </h3>
                <div class="chart-container" id="timeSeriesChart"></div>
            </div>

            <!-- Detailed Reports Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Reporte Detallado por Grupo</h3>
                    <div class="flex space-x-2">
                        <span class="text-sm text-gray-600">Actualizado: <span id="lastUpdate"></span></span>
                    </div>
                </div>
                <div class="report-table">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grupo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sede</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asistieron</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No Asistieron</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Porcentaje</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="detailedReportTable">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-3 block"></i>
                                    <p>Cargando datos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-400">&copy; 2024 PAE Barroblanco - Programa de Alimentaci√≥n Escolar. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let attendanceData = {
            sedes: {},
            grades: {},
            timeline: []
        };
        let allStudents = [];
        let sedeChartInstance = null;
        let gradeChartInstance = null;
        let timeSeriesChartInstance = null;

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando sistema de reportes...');
            
            // Verificar que BARROBLANCO_DATA est√© disponible
            if (typeof BARROBLANCO_DATA === 'undefined') {
                console.error('‚ùå BARROBLANCO_DATA no est√° definido');
                showNotification('Error: No se pudo cargar barroblanco-data.js', 'error');
                return;
            }
            
            console.log('‚úÖ BARROBLANCO_DATA cargado correctamente');
            
            // Cargar datos PAE si la funci√≥n existe
            if (typeof cargarDatosPAE === 'function') {
                console.log('üìö Cargando datos PAE...');
                cargarDatosPAE().then(() => {
                    console.log('‚úÖ Datos PAE cargados');
                    initializePage();
                }).catch(error => {
                    console.error('‚ùå Error cargando datos PAE:', error);
                    initializePage();
                });
            } else {
                console.log('‚ö†Ô∏è Funci√≥n cargarDatosPAE no encontrada, continuando...');
                initializePage();
            }
        });

        function initializePage() {
            console.log('üîß Inicializando p√°gina de reportes...');
            setDefaultDates();
            loadAllStudents();
            generateAttendanceData();
            populateFilters();
            updateStatistics();
            initializeCharts();
            generateDetailedReport();
            updateLastUpdateTime();
            console.log('‚úÖ P√°gina de reportes inicializada');
        }

        // ========================================
        // CARGA DE DATOS
        // ========================================
        function loadAllStudents() {
            allStudents = [];
            
            const sedes = BARROBLANCO_DATA.methods.getAllSedes();
            console.log('üìä Cargando estudiantes de', sedes.length, 'sedes');
            
            sedes.forEach(sede => {
                const estudiantesSede = BARROBLANCO_DATA.methods.getStudentsBySede(sede.id);
                console.log(`  - ${sede.name}: ${estudiantesSede.length} estudiantes`);
                allStudents = allStudents.concat(estudiantesSede);
            });
            
            console.log('üìö Total estudiantes cargados:', allStudents.length);
        }

        function generateAttendanceData() {
            console.log('üé≤ Generando datos de asistencia...');
            
            // Inicializar estructura de datos
            attendanceData.sedes = {};
            attendanceData.grades = {};
            
            // Agrupar estudiantes por sede y grupo
            const sedes = BARROBLANCO_DATA.methods.getAllSedes();
            
            sedes.forEach(sede => {
                const estudiantesSede = allStudents.filter(e => e.sede === sede.id);
                const totalSede = estudiantesSede.length;
                const attendedSede = Math.floor(totalSede * 0.93); // 93% asistencia promedio
                
                attendanceData.sedes[sede.id] = {
                    total: totalSede,
                    attended: attendedSede,
                    notAttended: totalSede - attendedSede
                };
                
                // Generar datos por grupo
                sede.groups.forEach(group => {
                    const estudiantesGrupo = estudiantesSede.filter(e => e.groupId === group.id);
                    const totalGrupo = estudiantesGrupo.length;
                    const attendedGrupo = Math.floor(totalGrupo * (0.90 + Math.random() * 0.08)); // 90-98% asistencia
                    
                    if (totalGrupo > 0) {
                        attendanceData.grades[group.id] = {
                            total: totalGrupo,
                            attended: attendedGrupo,
                            notAttended: totalGrupo - attendedGrupo,
                            sede: sede.id
                        };
                    }
                });
            });
            
            // Generar datos de serie temporal (√∫ltimos 30 d√≠as)
            generateTimelineData();
            
            console.log('‚úÖ Datos de asistencia generados');
            console.log('  - Sedes:', Object.keys(attendanceData.sedes).length);
            console.log('  - Grupos:', Object.keys(attendanceData.grades).length);
        }

        function generateTimelineData() {
            attendanceData.timeline = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                const dateStr = date.toISOString().split('T')[0];
                const totalStudents = allStudents.length;
                
                // Simular variaci√≥n diaria (88-95% asistencia)
                const baseAttendance = Math.floor(totalStudents * (0.88 + Math.random() * 0.07));
                
                attendanceData.timeline.push({
                    date: dateStr,
                    attended: baseAttendance,
                    total: totalStudents
                });
            }
        }

        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        // ========================================
        // FILTROS
        // ========================================
        function populateFilters() {
            // Cargar sedes
            const sedeFilter = document.getElementById('sedeFilter');
            sedeFilter.innerHTML = '<option value="">Todas las sedes</option>';
            
            const sedes = BARROBLANCO_DATA.methods.getAllSedes();
            sedes.forEach(sede => {
                const option = document.createElement('option');
                option.value = sede.id;
                option.textContent = sede.name;
                sedeFilter.appendChild(option);
            });
            
            // Cargar todos los grupos
            const gradeFilter = document.getElementById('gradeFilter');
            gradeFilter.innerHTML = '<option value="">Todos los grupos</option>';
            
            sedes.forEach(sede => {
                sede.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    // Evitar duplicaci√≥n: si name === id, mostrar solo el ID
                    const displayName = (group.name && group.name !== group.id) 
                        ? `${group.id} - ${group.name}` 
                        : group.id;
                    option.textContent = displayName;
                    if (group.type === 'sordos') {
                        option.textContent += ' ü§ü';
                    }
                    gradeFilter.appendChild(option);
                });
            });
            
            console.log('‚úÖ Filtros poblados');
        }

        function applyFilters() {
            console.log('üîç Aplicando filtros...');
            
            const sedeId = document.getElementById('sedeFilter').value;
            const grupoId = document.getElementById('gradeFilter').value;
            
            // Regenerar datos basados en filtros
            if (sedeId || grupoId) {
                let filteredStudents = allStudents;
                
                if (sedeId) {
                    filteredStudents = filteredStudents.filter(e => e.sede === sedeId);
                }
                
                if (grupoId) {
                    filteredStudents = filteredStudents.filter(e => e.groupId === grupoId);
                }
                
                // Recalcular todo con datos filtrados
                regenerateDataWithFilters(filteredStudents, sedeId, grupoId);
            } else {
                // Sin filtros, regenerar con todos los datos
                generateAttendanceData();
            }
            
            updateStatistics();
            updateCharts();
            generateDetailedReport();
            updateLastUpdateTime();
            showNotification('Filtros aplicados exitosamente', 'success');
        }

        function regenerateDataWithFilters(students, sedeId, grupoId) {
            attendanceData.sedes = {};
            attendanceData.grades = {};
            
            if (grupoId) {
                // Filtro por grupo espec√≠fico
                const totalGrupo = students.length;
                const attendedGrupo = Math.floor(totalGrupo * 0.93);
                
                const grupo = BARROBLANCO_DATA.methods.getGroupById(grupoId);
                if (grupo) {
                    attendanceData.grades[grupoId] = {
                        total: totalGrupo,
                        attended: attendedGrupo,
                        notAttended: totalGrupo - attendedGrupo,
                        sede: grupo.sede || students[0]?.sede
                    };
                    
                    const sedeIdForGroup = grupo.sede || students[0]?.sede;
                    if (sedeIdForGroup) {
                        attendanceData.sedes[sedeIdForGroup] = {
                            total: totalGrupo,
                            attended: attendedGrupo,
                            notAttended: totalGrupo - attendedGrupo
                        };
                    }
                }
            } else if (sedeId) {
                // Filtro por sede
                const totalSede = students.length;
                const attendedSede = Math.floor(totalSede * 0.93);
                
                attendanceData.sedes[sedeId] = {
                    total: totalSede,
                    attended: attendedSede,
                    notAttended: totalSede - attendedSede
                };
                
                // Agrupar por grupos de esa sede
                const sede = BARROBLANCO_DATA.methods.getSedeById(sedeId);
                if (sede) {
                    sede.groups.forEach(group => {
                        const estudiantesGrupo = students.filter(e => e.groupId === group.id);
                        const totalGrupo = estudiantesGrupo.length;
                        const attendedGrupo = Math.floor(totalGrupo * 0.93);
                        
                        if (totalGrupo > 0) {
                            attendanceData.grades[group.id] = {
                                total: totalGrupo,
                                attended: attendedGrupo,
                                notAttended: totalGrupo - attendedGrupo,
                                sede: sedeId
                            };
                        }
                    });
                }
            }
        }

        // ========================================
        // ESTAD√çSTICAS
        // ========================================
        function updateStatistics() {
            const totalStudents = Object.values(attendanceData.sedes).reduce((sum, sede) => sum + sede.total, 0);
            const totalAttended = Object.values(attendanceData.sedes).reduce((sum, sede) => sum + sede.attended, 0);
            
            // Contar estudiantes sordos
            let sordosCount = 0;
            Object.entries(attendanceData.grades).forEach(([gradeId, data]) => {
                const group = BARROBLANCO_DATA.methods.getGroupById(gradeId);
                if (group && group.type === 'sordos') {
                    sordosCount += data.total;
                }
            });
            
            const attendancePercentage = totalStudents > 0 ? ((totalAttended / totalStudents) * 100).toFixed(1) : 0;
            
            document.getElementById('totalStudents').textContent = totalStudents.toLocaleString();
            document.getElementById('attendanceToday').textContent = totalAttended.toLocaleString();
            document.getElementById('sordosCount').textContent = sordosCount.toLocaleString();
            document.getElementById('attendancePercentage').textContent = attendancePercentage + '%';
            
            console.log('üìä Estad√≠sticas actualizadas');
        }

        // ========================================
        // GR√ÅFICOS
        // ========================================
        function initializeCharts() {
            initializeSedeChart();
            initializeGradeChart();
            initializeTimeSeriesChart();
        }

        function updateCharts() {
            if (sedeChartInstance) {
                updateSedeChart();
            }
            if (gradeChartInstance) {
                updateGradeChart();
            }
        }

        function initializeSedeChart() {
            sedeChartInstance = echarts.init(document.getElementById('sedeChart'));
            updateSedeChart();
        }

        function updateSedeChart() {
            const sedes = Object.keys(attendanceData.sedes);
            const sedeNames = sedes.map(sedeId => {
                const sede = BARROBLANCO_DATA.methods.getSedeById(sedeId);
                return sede ? sede.name : sedeId;
            });
            
            const attendedData = sedes.map(sedeId => attendanceData.sedes[sedeId].attended);
            const notAttendedData = sedes.map(sedeId => attendanceData.sedes[sedeId].notAttended);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        let total = 0;
                        params.forEach(item => {
                            total += item.value;
                        });
                        params.forEach(item => {
                            const percentage = ((item.value / total) * 100).toFixed(1);
                            result += item.marker + ' ' + item.seriesName + ': ' + item.value + ' (' + percentage + '%)<br/>';
                        });
                        result += 'Total: ' + total;
                        return result;
                    }
                },
                legend: {
                    data: ['Asistieron', 'No Asistieron'],
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: sedeNames
                },
                series: [
                    {
                        name: 'Asistieron',
                        type: 'bar',
                        stack: 'total',
                        data: attendedData,
                        color: '#10b981',
                        label: {
                            show: true,
                            formatter: function(params) {
                                return params.value;
                            }
                        }
                    },
                    {
                        name: 'No Asistieron',
                        type: 'bar',
                        stack: 'total',
                        data: notAttendedData,
                        color: '#ef4444',
                        label: {
                            show: true,
                            formatter: function(params) {
                                return params.value;
                            }
                        }
                    }
                ]
            };

            sedeChartInstance.setOption(option);
        }

        function initializeGradeChart() {
            gradeChartInstance = echarts.init(document.getElementById('gradeChart'));
            updateGradeChart();
        }

        function updateGradeChart() {
            const grades = Object.keys(attendanceData.grades);
            const attendedData = grades.map(grade => attendanceData.grades[grade].attended);
            const notAttendedData = grades.map(grade => attendanceData.grades[grade].notAttended);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        let result = 'Grupo ' + params[0].name + '<br/>';
                        let total = 0;
                        params.forEach(item => {
                            total += item.value;
                        });
                        params.forEach(item => {
                            const percentage = ((item.value / total) * 100).toFixed(1);
                            result += item.marker + ' ' + item.seriesName + ': ' + item.value + ' (' + percentage + '%)<br/>';
                        });
                        result += 'Total: ' + total;
                        return result;
                    }
                },
                legend: {
                    data: ['Asistieron', 'No Asistieron'],
                    top: 0
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '5%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: grades,
                    axisLabel: {
                        rotate: 45,
                        interval: 0, // Mostrar todas las etiquetas
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: 'Asistieron',
                        type: 'bar',
                        stack: 'total',
                        data: attendedData,
                        color: '#10b981',
                        barMaxWidth: 40
                    },
                    {
                        name: 'No Asistieron',
                        type: 'bar',
                        stack: 'total',
                        data: notAttendedData,
                        color: '#ef4444',
                        barMaxWidth: 40
                    }
                ]
            };

            gradeChartInstance.setOption(option);
        }

        function initializeTimeSeriesChart() {
            timeSeriesChartInstance = echarts.init(document.getElementById('timeSeriesChart'));
            
            const dates = attendanceData.timeline.map(d => d.date);
            const attendanceValues = attendanceData.timeline.map(d => d.attended);

            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLabel: {
                        formatter: function(value) {
                            const date = new Date(value + 'T00:00:00');
                            return date.getDate() + '/' + (date.getMonth() + 1);
                        }
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    name: 'Asistencia Diaria',
                    type: 'line',
                    smooth: true,
                    data: attendanceValues,
                    areaStyle: {
                        color: 'rgba(59, 130, 246, 0.1)'
                    },
                    lineStyle: {
                        color: '#3b82f6'
                    },
                    itemStyle: {
                        color: '#3b82f6'
                    }
                }]
            };

            timeSeriesChartInstance.setOption(option);
        }

        // ========================================
        // TABLA DETALLADA
        // ========================================
        function generateDetailedReport() {
            const tbody = document.getElementById('detailedReportTable');
            tbody.innerHTML = '';

            const sortedGrades = Object.entries(attendanceData.grades)
                .sort(([a], [b]) => {
                    // Ordenar num√©ricamente
                    const numA = parseInt(a);
                    const numB = parseInt(b);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    return a.localeCompare(b);
                });

            sortedGrades.forEach(([gradeId, data]) => {
                const group = BARROBLANCO_DATA.methods.getGroupById(gradeId);
                const sede = group ? BARROBLANCO_DATA.methods.getSedeById(group.sede) : null;
                const percentage = ((data.attended / data.total) * 100).toFixed(1);
                const isSordos = group && group.type === 'sordos';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="font-medium">${gradeId}</span>
                            ${isSordos ? '<i class="fas fa-hands text-yellow-600 ml-2" title="Grupo Sordos"></i>' : ''}
                        </div>
                        <div class="text-sm text-gray-500">${group?.name || 'Sin nombre'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${sede ? `<span class="sede-badge sede-${group.sede}">${sede.name}</span>` : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">${data.attended}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">${data.notAttended}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${percentage}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${percentage >= 90 ? 'bg-green-100 text-green-800' : percentage >= 80 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${percentage >= 90 ? 'Excelente' : percentage >= 80 ? 'Bueno' : 'Necesita Mejora'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('‚úÖ Tabla detallada generada con', sortedGrades.length, 'grupos');
        }

        // ========================================
        // EXPORTACI√ìN
        // ========================================
        function exportReport() {
            console.log('üìä Exportando reporte a Excel...');
            
            // Preparar datos para Excel
            const data = [];
            
            // Encabezado de resumen
            data.push(['REPORTE DE ASISTENCIA PAE BARROBLANCO']);
            data.push(['Fecha de Generaci√≥n:', new Date().toLocaleDateString('es-CO')]);
            data.push(['']); // L√≠nea vac√≠a
            
            // Resumen por sede
            data.push(['RESUMEN POR SEDE']);
            data.push(['Sede', 'Total Estudiantes', 'Asistieron', 'No Asistieron', '% Asistencia']);
            
            Object.entries(attendanceData.sedes).forEach(([sedeId, sedeData]) => {
                const sede = BARROBLANCO_DATA.methods.getSedeById(sedeId);
                const percentage = ((sedeData.attended / sedeData.total) * 100).toFixed(1);
                data.push([
                    sede ? sede.name : sedeId,
                    sedeData.total,
                    sedeData.attended,
                    sedeData.notAttended,
                    percentage + '%'
                ]);
            });
            
            data.push(['']); // L√≠nea vac√≠a
            
            // Detalle por grupo
            data.push(['DETALLE POR GRUPO']);
            data.push(['Grupo', 'Sede', 'Total', 'Asistieron', 'No Asistieron', '% Asistencia', 'Estado']);
            
            Object.entries(attendanceData.grades).forEach(([gradeId, gradeData]) => {
                const group = BARROBLANCO_DATA.methods.getGroupById(gradeId);
                const sede = group ? BARROBLANCO_DATA.methods.getSedeById(group.sede) : null;
                const percentage = ((gradeData.attended / gradeData.total) * 100).toFixed(1);
                const estado = percentage >= 90 ? 'Excelente' : percentage >= 80 ? 'Bueno' : 'Necesita Mejora';
                
                data.push([
                    gradeId + (group && group.type === 'sordos' ? ' (Sordos)' : ''),
                    sede ? sede.name : '-',
                    gradeData.total,
                    gradeData.attended,
                    gradeData.notAttended,
                    percentage + '%',
                    estado
                ]);
            });
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 30 },
                { wch: 20 },
                { wch: 15 },
                { wch: 15 },
                { wch: 18 },
                { wch: 15 },
                { wch: 20 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte Asistencia');
            
            // Generar nombre de archivo
            const fecha = new Date().toISOString().split('T')[0];
            const filename = `Reporte_Asistencia_PAE_Barroblanco_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, filename);
            
            showNotification('Reporte Excel generado exitosamente', 'success');
            console.log('‚úÖ Excel exportado:', filename);
        }

        function printReport() {
            window.print();
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('es-CO');
        }

        function toggleFilters() {
            const filterSection = document.getElementById('filterSection');
            const toggle = document.getElementById('filterToggle');
            
            filterSection.classList.toggle('collapsed');
            toggle.classList.toggle('fa-chevron-down');
            toggle.classList.toggle('fa-chevron-up');
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('show');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg ${bgColor} text-white max-w-sm`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-3"></i>
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Redimensionar gr√°ficos cuando cambia el tama√±o de la ventana
        window.addEventListener('resize', function() {
            if (sedeChartInstance) sedeChartInstance.resize();
            if (gradeChartInstance) gradeChartInstance.resize();
            if (timeSeriesChartInstance) timeSeriesChartInstance.resize();
        });
    </script>
</body>
</html>